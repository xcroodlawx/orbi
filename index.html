<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orbi - Calculadora de Distância com Pedágio</title>
  <!-- CSS da UI do HERE Maps -->
  <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
  <!-- Scripts da API HERE -->
  <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
  <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
  <style>
    /* Regra @page para definir tamanho da impressão: 6in x 12in */
    @page {
      size: 11in 17in;
      margin: 0;
    }
    
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #fafcfe;
      color: #333;
    }
    header, footer {
      background-color: #cce4f7;
      text-align: center;
      padding: 0.8rem 1rem;
    }
    header img {
      max-height: 40px;
    }
    main {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }
    .calc-section {
      margin-bottom: 1rem;
    }
    .calc-section input,
    .calc-section button {
      width: 100%;
      padding: 0.6rem;
      margin: 0.2rem 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    .calc-section button {
      background: #e8d7f0;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .calc-section button:hover {
      background: #f3a2d4;
    }
    #suggestions {
      list-style: none;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 150px;
      overflow-y: auto;
    }
    #suggestions li {
      padding: 0.5rem;
      cursor: pointer;
    }
    #suggestions li:hover {
      background-color: #cce4f7;
    }
    /* Cabeçalho do recibo (exibido acima do mapa) */
    #receipt {
      padding: 1rem;
      border-bottom: 1px solid #ccc;
      margin-bottom: 1rem;
    }
    #receipt h2 {
      margin-bottom: 0.5rem;
    }
    /* Mapa: removidas bordas laterais e superior, mantendo apenas uma borda inferior */
    #map {
      width: 100%;
      height: 1000px;
      border-top: none;
      border-left: none;
      border-right: none;
      border-bottom: 1px solid #ccc;
      margin-bottom: 1rem;
      pointer-events: none;
    }
    .imprimir-btn {
      background: #007bff;
      color: #fff;
      padding: 0.6rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
    }
    .imprimir-btn:hover {
      background: #0056b3;
    }
    /* Elementos com a classe no-print serão ocultados na impressão */
    .no-print {
      display: block;
    }
    @media print {
      .no-print {
        display: none;
      }
      body {
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <header class="no-print">
    <img src="https://dummyimage.com/150x40/ccc/000.png&text=Logo+Orbi" alt="Logo Orbi" />
    <h1>Orbi</h1>
  </header>
  <main id="printContainer">
    <section class="calc-section no-print">
      <h2>Calculadora de Distância com Pedágio</h2>
      <input type="text" id="destino" placeholder="Digite o nome do local" autocomplete="off" />
      <ul id="suggestions"></ul>
      <button onclick="calcularDistancia()">Calcular</button>
      <p id="resultado"></p>
      <p id="tollInfo"></p>
      <!-- Botão que aciona a impressão padrão do navegador -->
      <button class="imprimir-btn no-print" onclick="prepararImpressao()">Imprimir Recibo</button>
    </section>
    
    <!-- Cabeçalho do Recibo -->
    <div id="receipt">
      <h2>Recibo de Viagem</h2>
      <p id="pOrigem">Origem: </p>
      <p id="pDestino">Destino: </p>
      <p id="pKmRodado">Km Rodado: </p>
      <p id="pPedagio">Valor do Pedágio: </p>
      <p id="pValorKm">Valor do Km: </p>
      <p id="pTotal">Total: </p>
    </div>
    
    <!-- Mapa dinâmico -->
    <div id="map"></div>
  </main>
  <footer class="no-print">
    <p>&copy; 2025 Orbi. Todos os direitos reservados.</p>
  </footer>

  <script>
    // Substitua "SUA_API_KEY_AQUI" pela sua chave válida HERE.
    const apiKey = "o2UlrzSQyEyGz0GG8MLHBFVyQrERHJiLzV0JqRtyexg";
    let map = null, platform;
    let currentLocation = null;
    let destinationCoords = null;
    const fallbackLocation = { lat: -23.550520, lng: -46.633308 };

    // Dados do recibo
    window.calculatedDistance = "";
    window.calculatedToll = "";
    window.originAddress = "";
    window.destinationAddress = "";
    window.encodedRoutePolyline = "";

    // Inicia a busca de sugestões enquanto o usuário digita (sem debounce)
    document.getElementById("destino").addEventListener("input", function() {
      const query = this.value.trim();
      destinationCoords = null;
      if (query.length < 1) {
        document.getElementById("suggestions").innerHTML = "";
        return;
      }
      fetchSuggestions(query);
    });

    function fetchSuggestions(query) {
      if (!currentLocation) {
        getUserLocation().then(loc => {
          currentLocation = loc;
          fetchSuggestions(query);
        });
        return;
      }
      const url = `https://autosuggest.search.hereapi.com/v1/autosuggest?at=${currentLocation.lat},${currentLocation.lng}&q=${encodeURIComponent(query)}&apiKey=${apiKey}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          const suggestions = document.getElementById("suggestions");
          suggestions.innerHTML = "";
          if (data.items && data.items.length > 0) {
            data.items.forEach(item => {
              if (item.position) {
                const li = document.createElement("li");
                li.textContent = item.title + (item.address && item.address.label ? " - " + item.address.label : "");
                li.addEventListener("click", () => {
                  document.getElementById("destino").value = item.title;
                  destinationCoords = { lat: item.position.lat, lng: item.position.lng };
                  if (item.address && item.address.label) {
                    window.destinationAddress = item.address.label;
                  }
                  suggestions.innerHTML = "";
                });
                suggestions.appendChild(li);
              }
            });
          }
        })
        .catch(error => console.error("Erro ao buscar sugestões:", error));
    }

    function getUserLocation() {
      return new Promise((resolve) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
            error => {
              console.error("Erro ao obter localização:", error);
              resolve(fallbackLocation);
            }
          );
        } else {
          resolve(fallbackLocation);
        }
      });
    }

    function reverseGeocode(coords) {
      const url = `https://revgeocode.search.hereapi.com/v1/revgeocode?at=${coords.lat},${coords.lng}&lang=pt-BR&apiKey=${apiKey}`;
      return fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.items && data.items.length > 0) {
            return data.items[0].address.label;
          } else {
            return "Endereço não encontrado";
          }
        })
        .catch(err => {
          console.error(err);
          return "Endereço não disponível";
        });
    }

    function initMap(lat, lng) {
      const mapContainer = document.getElementById("map");
      if (!mapContainer) return;
      if (map) {
        map.dispose();
        map = null;
      }
      while (mapContainer.firstChild) {
        mapContainer.removeChild(mapContainer.firstChild);
      }
      platform = new H.service.Platform({ apikey: apiKey });
      const defaultLayers = platform.createDefaultLayers();
      map = new H.Map(mapContainer, defaultLayers.vector.normal.map, {
        center: { lat, lng },
        zoom: 14,
        minZoom: 14,
        maxZoom: 14
      });
      const ui = H.ui.UI.createDefault(map, defaultLayers);
      ui.removeControl("zoom");
    }

    function addMarker(lat, lng, iconUrl) {
      const icon = new H.map.Icon(iconUrl);
      const marker = new H.map.Marker({ lat, lng }, { icon });
      map.addObject(marker);
    }

    function calcularDistancia() {
      getUserLocation().then(location => {
        currentLocation = location;
        initMap(location.lat, location.lng);
        // Marca a origem com ícone vermelho
        addMarker(location.lat, location.lng, 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png');
        reverseGeocode(location).then(address => {
          window.originAddress = address;
          updateReceipt();
        });
        if (destinationCoords) {
          processRoute(destinationCoords.lat, destinationCoords.lng);
        } else {
          const destino = document.getElementById("destino").value;
          if (destino.trim() === "") {
            document.getElementById("resultado").innerText = "Por favor, insira um destino.";
            document.getElementById("tollInfo").innerText = "";
            return;
          }
          fetch(`https://geocode.search.hereapi.com/v1/geocode?q=${encodeURIComponent(destino)}&apiKey=${apiKey}`)
            .then(response => response.json())
            .then(data => {
              if (data.items && data.items.length > 0) {
                const destinoLat = data.items[0].position.lat;
                const destinoLng = data.items[0].position.lng;
                if (data.items[0].address && data.items[0].address.label) {
                  window.destinationAddress = data.items[0].address.label;
                }
                processRoute(destinoLat, destinoLng);
              } else {
                document.getElementById("resultado").innerText = "Destino não encontrado.";
                document.getElementById("tollInfo").innerText = "Sem pedágios";
              }
            })
            .catch(error => {
              console.error("Erro ao buscar coordenadas:", error);
              document.getElementById("resultado").innerText = "Erro ao buscar coordenadas.";
              document.getElementById("tollInfo").innerText = "Sem pedágios";
            });
        }
      });
    }

    function processRoute(destinoLat, destinoLng) {
      // Marca o destino com ícone azul
      addMarker(destinoLat, destinoLng, 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png');
      window.destinationCoords = { lat: destinoLat, lng: destinoLng };
      const routingService = platform.getRoutingService(null, 8);
      const routeRequestParams = {
        transportMode: 'car',
        origin: `${currentLocation.lat},${currentLocation.lng}`,
        destination: `${destinoLat},${destinoLng}`,
        return: 'summary,polyline,travelSummary,tolls'
      };
      routingService.calculateRoute(routeRequestParams, result => {
        if (result.routes && result.routes.length > 0) {
          const route = result.routes[0];
          if (route.sections && route.sections.length > 0) {
            window.encodedRoutePolyline = route.sections[0].polyline || "";
          }
          const totalDistance = route.sections.reduce((acc, section) => {
            const dist = section.summary.length || section.summary.distance || 0;
            return acc + dist;
          }, 0) / 1000;
          document.getElementById("resultado").innerText = `Distância: ${totalDistance.toFixed(2)} km`;
          window.calculatedDistance = totalDistance.toFixed(2);
          // Desenha a rota (polyline)
          route.sections.forEach(section => {
            const lines = H.geo.LineString.fromFlexiblePolyline(section.polyline);
            const routePolyline = new H.map.Polyline(lines, { style: { strokeColor: 'blue', lineWidth: 4 } });
            map.addObject(routePolyline);
          });
          // Ajusta o mapa para incluir todos os marcadores e a rota com padding para evitar cortes
          const objects = map.getObjects().filter(o => typeof o.getBoundingBox === 'function');
          const bounds = objects.reduce((b, o) => b ? b.merge(o.getBoundingBox()) : o.getBoundingBox(), null);
          if (bounds) {
            map.getViewModel().setLookAtData({
              bounds: bounds,
              padding: { top: 120, bottom: 120, left: 120, right: 120 }
            });
          }
          // Calcula o pedágio, se houver
          try {
            const tollCost = route.sections.reduce((total, section) => {
              if (section.tolls && section.tolls.length > 0) {
                const sectionToll = section.tolls.reduce((subTotal, toll) => {
                  if (toll.fares && toll.fares.length > 0) {
                    const tollFareSum = toll.fares.reduce((fareSum, fare) => {
                      return fareSum + (fare.price && typeof fare.price.value === 'number' ? fare.price.value : 0);
                    }, 0);
                    return subTotal + tollFareSum;
                  }
                  return subTotal;
                }, 0);
                return total + sectionToll;
              }
              return total;
            }, 0);
            document.getElementById("tollInfo").innerText = tollCost > 0
              ? `Pedágio estimado: R$ ${tollCost.toFixed(2)}`
              : "Sem pedágios";
            window.calculatedToll = tollCost.toFixed(2);
          } catch (error) {
            console.error("Erro no cálculo do pedágio:", error);
            document.getElementById("tollInfo").innerText = "Sem pedágios";
          }
          updateReceipt();
        } else {
          document.getElementById("resultado").innerText = "Nenhuma rota encontrada.";
          document.getElementById("tollInfo").innerText = "Sem pedágios";
        }
      }, error => {
        console.error("Erro ao calcular a rota:", error);
        document.getElementById("resultado").innerText = "Erro ao calcular a rota.";
        document.getElementById("tollInfo").innerText = "Sem pedágios";
      });
    }

    function updateReceipt() {
      document.getElementById("pOrigem").innerText = `Origem: ${window.originAddress || "Não disponível"}`;
      document.getElementById("pDestino").innerText = `Destino: ${window.destinationAddress || "Não disponível"}`;
      document.getElementById("pKmRodado").innerText = `Km Rodado: ${window.calculatedDistance} km`;
      document.getElementById("pPedagio").innerText = `Valor do Pedágio: R$ ${window.calculatedToll}`;
      const kmValue = parseFloat(window.calculatedDistance) * 0.65;
      document.getElementById("pValorKm").innerText = `Valor do Km: R$ ${kmValue.toFixed(2)}`;
      const total = kmValue + parseFloat(window.calculatedToll || 0);
      document.getElementById("pTotal").innerText = `Total: R$ ${total.toFixed(2)}`;
    }

    function prepararImpressao() {
      updateReceipt();
      window.print();
    }
  </script>
</body>
</html>
